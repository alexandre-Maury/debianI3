#############################################################################################################
# Virtualization
#############################################################################################################

# Installation de VirtualBox
- name: Installer VirtualBox
  become: true
  block:

    # Assurer que les paquets nécessaires sont installés
    - name: Installer les paquets nécessaires
      ansible.builtin.apt:
        name: 
          - curl
          - gnupg2
          - lsb-release
        state: present
        update_cache: yes

    # Ajouter la clé GPG d'Oracle
    - name: Ajouter la clé GPG d'Oracle
      ansible.builtin.apt_key:
        url: https://www.virtualbox.org/download/oracle_vbox_2016.asc
        state: present

    # Ajouter le dépôt de VirtualBox
    - name: Ajouter le dépôt VirtualBox d'Oracle
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/oracle-virtualbox.gpg] https://download.virtualbox.org/virtualbox/debian {{ ansible_distribution_release }} contrib"
        filename: "oracle-virtualbox"
        state: present

    # Mettre à jour le cache des paquets apt
    - name: Mettre à jour le cache apt
      ansible.builtin.apt:
        update_cache: yes

    # Installer VirtualBox 7.0
    - name: Installer VirtualBox 7.0
      ansible.builtin.apt:
        name: virtualbox-7.0
        state: present

    # Installer les paquets supplémentaires pour VirtualBox
    - name: Installer les paquets supplémentaires pour VirtualBox
      ansible.builtin.apt:
        name:
          - dkms
          - linux-headers-{{ ansible_kernel }}
          - virtualbox-ext-pack
        state: present

    - name: Enregistrer la liste des réseaux NAT de VirtualBox
      ansible.builtin.shell: VBoxManage natnetwork list
      changed_when: false
      register: virtualbox_natnetwork

    - name: Ajouter un réseau NAT à VirtualBox
      ansible.builtin.shell: VBoxManage natnetwork add --netname NatNetwork --network "10.0.2.0/24" --enable
      changed_when: virtualbox_natnetwork.stdout | regex_search('0 networks found')

    - name: Enregistrer la liste des interfaces host-only de VirtualBox
      ansible.builtin.shell: VBoxManage list hostonlyifs
      changed_when: false
      register: virtualbox_host_only_network

    - name: Ajouter un réseau host-only à VirtualBox
      ansible.builtin.shell: VBoxManage hostonlyif create
      changed_when: virtualbox_host_only_network.stdout | length == 0

# Installation de KVM
- name: Installer KVM
  become: true
  block:
    - name: Installer les dépendances de virtualisation KVM
      ansible.builtin.apt:
        name:
          - qemu-kvm
          - libvirt-daemon-system
          - virtinst
          - libvirt-clients
          - bridge-utils
          - virt-manager
        update_cache: yes  # Met à jour le cache des paquets avant l'installation

    - name: Activer et démarrer le service libvirtd
      ansible.builtin.systemd:
        name: libvirtd
        enabled: true
        state: started

    - name: Ajouter l'utilisateur au groupe KVM et Libvirt
      ansible.builtin.user:
        name: '{{ ansible_user_id }}'
        append: true
        groups:
          - kvm
          - libvirt
